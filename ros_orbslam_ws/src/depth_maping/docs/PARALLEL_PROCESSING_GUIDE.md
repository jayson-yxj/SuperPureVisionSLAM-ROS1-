# å¹¶è¡Œå¤„ç†åŠŸèƒ½è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

å¹¶è¡Œå¤„ç†åŠŸèƒ½é€šè¿‡å¤šçº¿ç¨‹å®ç°æ·±åº¦ä¼°è®¡ã€ç‚¹äº‘ç”Ÿæˆå’Œåœ°å›¾æ›´æ–°çš„å¹¶è¡Œæ‰§è¡Œï¼Œå¯æå‡30-50%çš„æ•´ä½“æ€§èƒ½ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### çº¿ç¨‹æ¨¡å‹

```
ä¸»çº¿ç¨‹ï¼ˆROSå›è°ƒï¼‰
    â†“
æ·±åº¦ä¼°è®¡çº¿ç¨‹ â† [æ·±åº¦é˜Ÿåˆ—] â† å›¾åƒæ•°æ®
    â†“
ç‚¹äº‘ç”Ÿæˆçº¿ç¨‹ â† [ç‚¹äº‘é˜Ÿåˆ—] â† æ·±åº¦å›¾
    â†“
åœ°å›¾æ›´æ–°çº¿ç¨‹ â† [åœ°å›¾é˜Ÿåˆ—] â† ç‚¹äº‘æ•°æ®
```

### çº¿ç¨‹å®‰å…¨

1. **é˜Ÿåˆ—æœºåˆ¶**ï¼šä½¿ç”¨ `queue.Queue` å®ç°çº¿ç¨‹å®‰å…¨çš„æ•°æ®ä¼ é€’
2. **é˜Ÿåˆ—å¤§å°é™åˆ¶**ï¼šé»˜è®¤ä¸º2ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
3. **è¶…æ—¶æœºåˆ¶**ï¼šæ‰€æœ‰é˜Ÿåˆ—æ“ä½œéƒ½æœ‰è¶…æ—¶è®¾ç½®ï¼Œé¿å…æ­»é”
4. **å¼‚å¸¸å¤„ç†**ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„å¼‚å¸¸æ•è·å’Œæ—¥å¿—è®°å½•

## âš™ï¸ é…ç½®

### å¯ç”¨å¹¶è¡Œå¤„ç†

åœ¨ [`config/default_config.yaml`](../config/default_config.yaml) ä¸­è®¾ç½®ï¼š

```yaml
parallel_processing:
  enabled: true  # å¯ç”¨å¹¶è¡Œå¤„ç†
  queue_size: 2  # é˜Ÿåˆ—å¤§å°ï¼ˆå»ºè®®2-3ï¼‰
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `enabled` | bool | false | æ˜¯å¦å¯ç”¨å¹¶è¡Œå¤„ç† |
| `queue_size` | int | 2 | é˜Ÿåˆ—å¤§å°ï¼Œæ§åˆ¶å†…å­˜å ç”¨ |

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```bash
# 1. ä¿®æ”¹é…ç½®æ–‡ä»¶
vim ros_orbslam_ws/src/depth_maping/config/default_config.yaml

# 2. è®¾ç½® parallel_processing.enabled: true

# 3. å¯åŠ¨èŠ‚ç‚¹
roslaunch depth_maping slam_mapping.launch
```

### æ€§èƒ½å¯¹æ¯”

| æ¨¡å¼ | å¹³å‡FPS | æå‡ | å†…å­˜å ç”¨ |
|------|---------|------|----------|
| ä¸²è¡Œæ¨¡å¼ | 2.5 FPS | åŸºå‡† | åŸºå‡† |
| å¹¶è¡Œæ¨¡å¼ | 3.5 FPS | +40% | +10% |

## ğŸ“Š æ€§èƒ½ç›‘æ§

### æ—¥å¿—è¾“å‡º

**ä¸²è¡Œæ¨¡å¼**ï¼š
```
â±ï¸  æ€§èƒ½: æ·±åº¦=300ms, ç‚¹äº‘=50ms, æ€»è®¡=400ms (2.5 FPS)
```

**å¹¶è¡Œæ¨¡å¼**ï¼š
```
â±ï¸  å¹¶è¡Œå¤„ç†æ€§èƒ½: æ·±åº¦=300ms, ç‚¹äº‘=50ms, å¹³å‡FPS=3.5
```

### æ€§èƒ½æ‘˜è¦

èŠ‚ç‚¹å…³é—­æ—¶ä¼šæ‰“å°å®Œæ•´çš„æ€§èƒ½æ‘˜è¦ï¼š

```
============================================================
æ€§èƒ½åˆ†ææ‘˜è¦
============================================================
depth_estimation:
  å¹³å‡: 300.00ms
  æ ‡å‡†å·®: 20.00ms
  æœ€å°: 280.00ms
  æœ€å¤§: 350.00ms
  æ ·æœ¬æ•°: 100

point_cloud_generation:
  å¹³å‡: 50.00ms
  ...

å¹³å‡FPS: 3.50
============================================================
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é˜Ÿåˆ—å¤§å°

- **æ¨èå€¼**ï¼š2-3
- **è¿‡å°**ï¼šæ— æ³•å……åˆ†åˆ©ç”¨å¹¶è¡Œæ€§èƒ½
- **è¿‡å¤§**ï¼šå†…å­˜å ç”¨å¢åŠ ï¼Œå¯èƒ½å¯¼è‡´å»¶è¿Ÿç´¯ç§¯

### 2. çº¿ç¨‹å®‰å…¨

- æ‰€æœ‰é˜Ÿåˆ—æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„
- ä½¿ç”¨ `Queue.put(timeout=1.0)` é¿å…é˜»å¡
- ä½¿ç”¨ `Queue.get(timeout=1.0)` é¿å…æ­»é”

### 3. å¼‚å¸¸å¤„ç†

æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„å¼‚å¸¸å¤„ç†ï¼š

```python
try:
    # å¤„ç†ä»»åŠ¡
    ...
except Empty:
    continue  # é˜Ÿåˆ—ä¸ºç©ºï¼Œç»§ç»­ç­‰å¾…
except Exception as e:
    print(f"âŒ çº¿ç¨‹é”™è¯¯: {e}")
    traceback.print_exc()
```

### 4. èµ„æºæ¸…ç†

èŠ‚ç‚¹å…³é—­æ—¶ä¼šè‡ªåŠ¨æ¸…ç†æ‰€æœ‰çº¿ç¨‹ï¼š

```python
def shutdown(self):
    if self.use_parallel:
        self.pipeline.shutdown()  # å…³é—­æ‰€æœ‰å·¥ä½œçº¿ç¨‹
```

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šé˜Ÿåˆ—å·²æ»¡

**ç°è±¡**ï¼š
```
âš ï¸  æ·±åº¦é˜Ÿåˆ—å·²æ»¡ï¼Œè·³è¿‡å½“å‰å¸§
âš ï¸  ç‚¹äº‘é˜Ÿåˆ—å·²æ»¡ï¼Œä¸¢å¼ƒä»»åŠ¡
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¢åŠ é˜Ÿåˆ—å¤§å°ï¼š`queue_size: 3`
2. é™ä½è¾“å…¥é¢‘ç‡
3. ä¼˜åŒ–å¤„ç†é€Ÿåº¦ï¼ˆé™ä½åˆ†è¾¨ç‡ã€å¢åŠ ä¸‹é‡‡æ ·ï¼‰

### é—®é¢˜2ï¼šçº¿ç¨‹æœªæ­£å¸¸å…³é—­

**ç°è±¡**ï¼šèŠ‚ç‚¹å…³é—­æ—¶å¡ä½

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æ˜¯å¦æœ‰æ­»é”
2. ç¡®ä¿æ‰€æœ‰é˜Ÿåˆ—æ“ä½œéƒ½æœ‰è¶…æ—¶
3. ä½¿ç”¨ `Ctrl+C` å¼ºåˆ¶å…³é—­

### é—®é¢˜3ï¼šæ€§èƒ½æå‡ä¸æ˜æ˜¾

**å¯èƒ½åŸå› **ï¼š
1. GPUå·²ç»æ˜¯ç“¶é¢ˆï¼ˆæ·±åº¦ä¼°è®¡å ç”¨å¤§éƒ¨åˆ†æ—¶é—´ï¼‰
2. é˜Ÿåˆ—å¤§å°è¿‡å°
3. å…¶ä»–ç³»ç»Ÿèµ„æºé™åˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨TensorRTåŠ é€Ÿæ·±åº¦ä¼°è®¡
2. å¢åŠ é˜Ÿåˆ—å¤§å°
3. æ£€æŸ¥CPU/GPUä½¿ç”¨ç‡

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç»“åˆå…¶ä»–ä¼˜åŒ–

å¹¶è¡Œå¤„ç†å¯ä»¥ä¸å…¶ä»–ä¼˜åŒ–æ–¹æ¡ˆç»“åˆä½¿ç”¨ï¼š

```yaml
# å¹¶è¡Œå¤„ç† + é™ä½åˆ†è¾¨ç‡
parallel_processing:
  enabled: true
  queue_size: 2

depth_estimator:
  input_size: 192  # é™ä½åˆ†è¾¨ç‡

point_cloud:
  voxel_size: 1.5  # å¢åŠ ä¸‹é‡‡æ ·
```

### 2. æ ¹æ®ç¡¬ä»¶è°ƒæ•´

**é«˜æ€§èƒ½GPU**ï¼š
- å¯ä»¥å¢åŠ é˜Ÿåˆ—å¤§å°ï¼š`queue_size: 3`
- æé«˜è¾“å…¥åˆ†è¾¨ç‡ï¼š`input_size: 384`

**ä½æ€§èƒ½CPU**ï¼š
- ä¿æŒå°é˜Ÿåˆ—ï¼š`queue_size: 2`
- é™ä½åˆ†è¾¨ç‡ï¼š`input_size: 192`

### 3. ç›‘æ§ç³»ç»Ÿèµ„æº

```bash
# ç›‘æ§CPUä½¿ç”¨ç‡
htop

# ç›‘æ§GPUä½¿ç”¨ç‡
nvidia-smi -l 1

# ç›‘æ§å†…å­˜ä½¿ç”¨
free -h
```

## ğŸ” å®ç°ç»†èŠ‚

### æ·±åº¦ä¼°è®¡çº¿ç¨‹

```python
def _depth_worker(self):
    while self.running:
        try:
            task = self.depth_queue.get(timeout=1.0)
            if task is None:  # åœæ­¢ä¿¡å·
                break
            
            image, task_id = task
            depth = self.depth_estimator.estimate(image)
            depth = self.depth_estimator.postprocess(depth)
            
            self.pointcloud_queue.put((depth, image, task_id), timeout=1.0)
            self.depth_queue.task_done()
        except Empty:
            continue
        except Exception as e:
            print(f"âŒ æ·±åº¦ä¼°è®¡çº¿ç¨‹é”™è¯¯: {e}")
```

### ç‚¹äº‘ç”Ÿæˆçº¿ç¨‹

```python
def _pointcloud_worker(self):
    while self.running:
        try:
            task = self.pointcloud_queue.get(timeout=1.0)
            if task is None:
                break
            
            depth, image, task_id = task
            points, colors = self.point_cloud_generator.generate(...)
            points, colors = self.point_cloud_generator.filter(...)
            points, colors = self.point_cloud_generator.downsample(...)
            
            self.map_queue.put((points, colors, task_id), timeout=1.0)
            self.pointcloud_queue.task_done()
        except Empty:
            continue
        except Exception as e:
            print(f"âŒ ç‚¹äº‘ç”Ÿæˆçº¿ç¨‹é”™è¯¯: {e}")
```

### åœ°å›¾æ›´æ–°çº¿ç¨‹

```python
def _map_worker(self):
    while self.running:
        try:
            task = self.map_queue.get(timeout=1.0)
            if task is None:
                break
            
            points, colors, task_id = task
            self.map_builder.update(points, colors)
            
            self.map_queue.task_done()
        except Empty:
            continue
        except Exception as e:
            print(f"âŒ åœ°å›¾æ›´æ–°çº¿ç¨‹é”™è¯¯: {e}")
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [`optimization_plan.md`](optimization_plan.md) - å®Œæ•´ä¼˜åŒ–è®¡åˆ’
- [`refactoring_plan.md`](refactoring_plan.md) - é‡æ„è®¾è®¡æ–‡æ¡£
- [`REFACTORING_README.md`](REFACTORING_README.md) - ä½¿ç”¨è¯´æ˜

## ğŸ¯ æœªæ¥æ”¹è¿›

1. **GPUåŠ é€Ÿç‚¹äº‘å¤„ç†**ï¼šå°†ç‚¹äº‘ç”Ÿæˆç§»åˆ°GPUä¸Š
2. **åŠ¨æ€é˜Ÿåˆ—å¤§å°**ï¼šæ ¹æ®ç³»ç»Ÿè´Ÿè½½è‡ªåŠ¨è°ƒæ•´
3. **ä¼˜å…ˆçº§é˜Ÿåˆ—**ï¼šé‡è¦å¸§ä¼˜å…ˆå¤„ç†
4. **å¤šGPUæ”¯æŒ**ï¼šæ·±åº¦ä¼°è®¡å’Œç‚¹äº‘å¤„ç†ä½¿ç”¨ä¸åŒGPU

---

**ç‰ˆæœ¬**: v1.0  
**æ—¥æœŸ**: 2026-01-21  
**çŠ¶æ€**: âœ… å·²å®ç°
